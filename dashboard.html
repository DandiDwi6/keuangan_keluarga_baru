<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins}
body{background:linear-gradient(135deg,#eef2ff,#f8fafc);}

/* TOPBAR */
.topbar{
position:fixed;top:0;left:0;width:100%;height:70px;
background:linear-gradient(135deg,#2563eb,#3b82f6);
color:white;display:flex;align-items:center;padding:0 25px;
z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.menu-btn{font-size:22px;cursor:pointer;margin-right:15px}

/* SIDEBAR */
.sidebar{
position:fixed;top:70px;left:-260px;width:260px;height:calc(100% - 70px);
background:linear-gradient(135deg,#2563eb,#3b82f6);
padding-top:20px;transition:.3s;z-index:1000;
}
.sidebar.show{left:0}
.sidebar a{
display:flex;gap:12px;padding:18px 25px;
color:#cbd5e1;text-decoration:none;
}
.sidebar a:hover{background:rgba(255,255,255,.1);color:white}

/* OVERLAY */
.overlay{
position:fixed;inset:0;background:rgba(0,0,0,.4);
opacity:0;pointer-events:none;transition:.3s;z-index:900;
}
.overlay.show{opacity:1;pointer-events:auto}

/* MAIN */
.main{padding:100px 30px 30px}

/* HEADER CARD */
.header{
background:linear-gradient(135deg,#2563eb,#3b82f6);
padding:25px 30px;border-radius:20px;color:white;
margin-bottom:30px;display:flex;justify-content:space-between;
align-items:center;box-shadow:0 20px 40px rgba(0,0,0,.2);
}

.logout{
background:rgba(255,255,255,.2);
border:none;padding:10px 18px;border-radius:10px;
color:white;cursor:pointer;font-weight:600;
}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:25px}
.card{background:white;padding:25px;border-radius:18px;box-shadow:0 15px 35px rgba(0,0,0,.08)}
.title{font-size:14px;color:#64748b}
.value{font-size:32px;font-weight:600;margin-top:10px}
.green{color:#16a34a}
.red{color:#dc2626}

/* TABLE */
.table{
margin-top:35px;background:white;border-radius:18px;
padding:25px;box-shadow:0 15px 35px rgba(0,0,0,.08);
height:300px;overflow-y:auto;
}
table{width:100%;border-collapse:collapse}
th,td{padding:14px;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;text-align:left;position:sticky;top:0}

/* FAB */
.fab{
position:fixed;right:30px;bottom:30px;width:65px;height:65px;
border-radius:50%;border:none;
background:linear-gradient(135deg,#2563eb,#3b82f6);
color:white;font-size:34px;cursor:pointer;
}
/* ALERT SALDO TIPIS */
.blink {
  color: #dc2626 !important;
  animation: blinkAnim 1s infinite;
}
/* PROGRESS SALDO */
.progressBar{
  width:100%;
  height:6px;
  background:#e5e7eb;
  border-radius:10px;
  margin-top:10px;
  overflow:hidden;
}

#barBekal{
  height:100%;
  width:100%;
  background:#16a34a;
  transition:0.4s;
}

@keyframes blinkAnim {
  0% { opacity: 1; }
  50% { opacity: 0.2; }
  100% { opacity: 1; }
}

/* LOADER */
.loader{
position:fixed;inset:0;background:white;
display:flex;justify-content:center;align-items:center;
z-index:9999;
}
.spinner{
width:60px;height:60px;border:6px solid #e5e7eb;
border-top:6px solid #2563eb;border-radius:50%;
animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}


</style>
</head>

<body>

<div class="loader" id="loader"><div class="spinner"></div></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
<a href="dashboard.html">üè† Dashboard</a>
<a href="transaksi.html" id="menuTransaksi">üí∏ Transaksi</a>
<a href="bekal.html">üíº Bekal</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<!-- TOPBAR -->
<div class="topbar">
<div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
<div>üí≥ Dashboard</div>
</div>

<!-- MAIN -->
<div class="main">

<div class="header">
<div>
<div id="welcome"></div>
<div id="today"></div>
</div>
<button class="logout" onclick="logout()">Logout</button>
</div>

<div class="cards">
<div class="card">
<div class="title">Saldo Total</div>
<div class="value" id="saldo">Rp 0</div>
</div>

<div class="card">
<div class="title">Pemasukan</div>
<div class="value green" id="income">Rp 0</div>
</div>

<div class="card">
<div class="title">Pengeluaran</div>
<div class="value red" id="expense">Rp 0</div>
</div>

<div class="card">
<div class="title">Saldo Bekal</div>
<div class="value" id="saldoBekalEl">Rp 0</div>
<div id="warningBekal" style="display:none;font-size:13px;margin-top:6px;color:#dc2626;font-weight:600;">
‚ö†Ô∏è Saldo bekal hampir habis
</div>

<div class="progressBar">
  <div id="barBekal"></div>
</div>
</div>
</div>

<div class="table">
<h3>Transaksi Terbaru</h3>
<table id="tbl">
<tr><th>Tanggal</th><th>Jenis</th><th>Nominal</th></tr>
</table>
</div>

</div>

<button id="btnTambah" class="fab" onclick="location='transaksi.html'">+</button>

<script>
const url="https://script.google.com/macros/s/AKfycbykSlA2XD2AsovwsQBfqvbmMnSLUchFsyjxr6QdCoKstySkaEC7E9iw-Rab_u3ih8T7/exec";

/* MENU */
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
function toggleMenu(){
sidebar.classList.toggle("show");
overlay.classList.toggle("show");
}

/* DATE */
today.innerText=new Date().toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

/* AUTH */
const user=localStorage.getItem("user");
const role=localStorage.getItem("role");
if(!user)location="index.html";
welcome.innerText="Halo, "+user+" üëã";

if(role==="user"){
menuTransaksi.style.display="none";
btnTambah.style.display="none";
}

function logout(){localStorage.clear();location="index.html"}

/* ================= LOAD SALDO UTAMA ================= */
fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"TRANSACTIONS"})})
.then(r=>r.json())
.then(data=>{

let saldoTotal=0,incomeTotal=0,expenseTotal=0;

for(let i=1;i<data.length;i++){
const row=data[i];
const jenis=row[2];
const nominal=Number(row[5])||0;

if(jenis==="income"){incomeTotal+=nominal;saldoTotal+=nominal}
if(jenis==="expense"){expenseTotal+=nominal;saldoTotal-=nominal}

if(i>data.length-6){
tbl.innerHTML+=`<tr>
<td>${row[1]}</td>
<td>${jenis}</td>
<td>Rp ${nominal.toLocaleString()}</td>
</tr>`;
}
}

saldo.innerText="Rp "+saldoTotal.toLocaleString();
income.innerText="Rp "+incomeTotal.toLocaleString();
expense.innerText="Rp "+expenseTotal.toLocaleString();

});

/* ================= SALDO BEKAL REAL ================= */

let totalBekal = 0;
let totalKeluarBekal = 0;

/* AMBIL DATA BEKAL MASUK */
fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"BEKAL"})})
.then(r=>r.json())
.then(data=>{

for(let i=1;i<data.length;i++){
const row=data[i];
const nominal=Number(row[2])||0;
totalBekal += nominal;
}

/* AMBIL DATA PENGELUARAN BEKAL */
return fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"PENGELUARAN_BEKAL"})});
})
.then(r=>r.json())
.then(data=>{

for(let i=1;i<data.length;i++){
const row=data[i];
const nominal=Number(row[2])||0;
totalKeluarBekal += nominal;
}

const saldoBekal = totalBekal - totalKeluarBekal;
saldoBekalEl.innerText="Rp "+saldoBekal.toLocaleString();

const batasTipis = 50000;
const warning = document.getElementById("warningBekal");
const bar = document.getElementById("barBekal");

/* HITUNG PERSENTASE SALDO */
const persen = Math.max((saldoBekal / totalBekal) * 100, 5);
bar.style.width = persen + "%";

/* WARNA PROGRESS */
if(persen > 50) bar.style.background="#16a34a";
else if(persen > 25) bar.style.background="#f59e0b";
else bar.style.background="#dc2626";

/* ALERT SALDO TIPIS */
if(saldoBekal <= batasTipis){

  saldoBekalEl.classList.add("blink");
  warning.style.display="block";

  /* POPUP SEKALI SAJA */
  if(!localStorage.getItem("alertBekalShown")){
    setTimeout(()=>{
      alert("‚ö†Ô∏è Saldo bekal hampir habis!");
    },500);
    localStorage.setItem("alertBekalShown","yes");
  }

}else{
  saldoBekalEl.classList.remove("blink");
  warning.style.display="none";
  localStorage.removeItem("alertBekalShown");
}



loader.style.display="none";

});

</script>

</body>
</html>
