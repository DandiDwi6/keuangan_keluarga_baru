<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins}
body{background:linear-gradient(135deg,#eef2ff,#f8fafc);}

/* TOPBAR */
.topbar{
position:fixed;top:0;left:0;width:100%;height:80px;
background:linear-gradient(135deg,#2563eb,#3b82f6);
color:white;display:flex;align-items:center;justify-content:space-between;
padding:0 25px;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.25);
}

.top-left{display:flex;align-items:center;gap:15px}
.menu-btn{font-size:22px;cursor:pointer}

.user-info{
display:flex;flex-direction:column;font-size:14px;
}

.logout{
background:rgba(255,255,255,.2);
border:none;padding:8px 16px;border-radius:10px;
color:white;cursor:pointer;font-weight:600;
}

/* SIDEBAR */
.sidebar{
position:fixed;top:80px;left:-260px;width:260px;height:calc(100% - 80px);
background:linear-gradient(135deg,#2563eb,#3b82f6);
padding-top:20px;transition:.3s;z-index:1000;
}
.sidebar.show{left:0}
.sidebar a{display:flex;gap:12px;padding:18px 25px;color:#cbd5e1;text-decoration:none;}
.sidebar a:hover{background:rgba(255,255,255,.1);color:white}

/* OVERLAY */
.overlay{
position:fixed;inset:0;background:rgba(0,0,0,.4);
opacity:0;pointer-events:none;transition:.3s;z-index:900;
}
.overlay.show{opacity:1;pointer-events:auto}

/* MAIN */
.main{padding:120px 30px 30px}

/* RUNNING TEXT */
.runningBox{
background:white;border-radius:14px;padding:10px;margin-bottom:25px;
overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.08);
}

#runningText{
white-space:nowrap;
display:inline-block;
animation:runText 12s linear infinite;
font-weight:600;
color:#1e293b;
}

/* ‚≠ê FIX MOBILE BUG DI SINI */
@keyframes runText{
0%{transform:translateX(100%)}
100%{transform:translateX(-100%)}
}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:25px}
.card{background:white;padding:25px;border-radius:18px;box-shadow:0 15px 35px rgba(0,0,0,.08)}
.title{font-size:14px;color:#64748b}
.value{font-size:32px;font-weight:600;margin-top:10px}
.green{color:#16a34a}
.red{color:#dc2626}

/* TABLE */
.table{margin-top:35px;background:white;border-radius:18px;padding:25px;
box-shadow:0 15px 35px rgba(0,0,0,.08);height:300px;overflow-y:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:14px;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;text-align:left;position:sticky;top:0}

/* FAB */
.fab{position:fixed;right:30px;bottom:30px;width:50px;height:50px;border-radius:50%;
border:none;background:linear-gradient(135deg,#2563eb,#3b82f6);
color:white;font-size:34px;cursor:pointer}

/* BLINK */
.blink { color:#dc2626!important; animation:blinkAnim 1s infinite; }
@keyframes blinkAnim{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}

.progressBar{width:100%;height:6px;background:#e5e7eb;border-radius:10px;margin-top:10px;overflow:hidden}
#barBekal{height:100%;width:100%;background:#16a34a;transition:.4s}

.loader{position:fixed;inset:0;background:white;display:flex;justify-content:center;align-items:center;z-index:9999}
.spinner{width:60px;height:60px;border:6px solid #e5e7eb;border-top:6px solid #2563eb;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.eye{cursor:pointer;font-size:18px;margin-left:8px}
</style>
</head>

<body>

<div class="loader" id="loader"><div class="spinner"></div></div>

<div class="sidebar" id="sidebar">
<a href="dashboard.html">üè† Dashboard</a>
<a href="transaksi.html" id="menuTransaksi">üí∏ Transaksi</a>
<a href="bekal.html">üíº Bekal</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="topbar">
<div class="top-left">
<div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
<div class="user-info">
<div id="welcome"></div>
<div id="today" style="font-size:12px;opacity:.8"></div>
</div>
</div>
<button class="logout" onclick="logout()">Logout</button>
</div>

<div class="main">

<div class="runningBox">
<div id="runningText">Loading info keuangan...</div>
</div>

<div class="cards">
<div class="card">
<div class="title">Saldo Total <span class="eye" id="eyeBtn">üëì</span></div>
<div class="value" id="saldo">Rp ****</div>
</div>

<div class="card">
<div class="title">Pemasukan</div>
<div class="value green" id="income">Rp ****</div>
</div>

<div class="card">
<div class="title">Pengeluaran</div>
<div class="value red" id="expense">Rp ****</div>
</div>

<div class="card">
<div class="title">Saldo Bekal</div>
<div class="value" id="saldoBekalEl">Rp ****</div>
<div id="warningBekal" style="display:none;font-size:13px;margin-top:6px;color:#dc2626;font-weight:600;">‚ö†Ô∏è Saldo bekal hampir habis</div>
<div class="progressBar"><div id="barBekal"></div></div>
</div>
</div>

<div class="table">
<h3>Transaksi Terbaru</h3>
<table id="tbl">
<tr><th>Tanggal</th><th>Jenis</th><th>Nominal</th></tr>
</table>
</div>

</div>

<button id="btnTambah" class="fab" onclick="location='transaksi.html'">+</button>

<script>
/* JS TIDAK DIUBAH SAMA SEKALI */
const url="https://script.google.com/macros/s/AKfycbykSlA2XD2AsovwsQBfqvbmMnSLUchFsyjxr6QdCoKstySkaEC7E9iw-Rab_u3ih8T7/exec";

/* MENU */
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
function toggleMenu(){sidebar.classList.toggle("show");overlay.classList.toggle("show");}

/* DATE */
today.innerText=new Date().toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

/* AUTH */
const user=localStorage.getItem("user");
const role=localStorage.getItem("role");
if(!user)location="index.html";
welcome.innerText="Halo, "+user+" üëã";
if(role==="user"){menuTransaksi.style.display="none";btnTambah.style.display="none";}
function logout(){localStorage.clear();location="index.html"}

/* FORMAT */
function rp(n){return "Rp "+Number(n).toLocaleString("id-ID");}

/* ANIMASI COUNT UP */
function animate(el,end){
let start=0;
let duration=800;
let startTime=null;
function step(t){
if(!startTime)startTime=t;
let progress=Math.min((t-startTime)/duration,1);
let val=Math.floor(progress*(end-start)+start);
el.innerText=rp(val);
if(progress<1)requestAnimationFrame(step);
}
requestAnimationFrame(step);
}

/* HIDE SALDO */
let hideSaldo=true;
let _saldoTotal=0,_incomeTotal=0,_expenseTotal=0,_saldoBekal=0;

function renderSaldo(){
if(hideSaldo){
saldo.innerText="Rp ****";
income.innerText="Rp ****";
expense.innerText="Rp ****";
saldoBekalEl.innerText="Rp ****";
eyeBtn.innerText="üï∂Ô∏è";
}else{
animate(saldo,_saldoTotal);
animate(income,_incomeTotal);
animate(expense,_expenseTotal);
animate(saldoBekalEl,_saldoBekal);
eyeBtn.innerText="üëì";
}
}
eyeBtn.onclick=()=>{
hideSaldo=!hideSaldo;
renderSaldo();
updateRunningText();
}

/* RUNNING TEXT */
const tanggalGajian=25;
function updateRunningText(){
const todayDate=new Date();
let next=new Date(todayDate.getFullYear(),todayDate.getMonth(),tanggalGajian);
if(todayDate.getDate()>tanggalGajian) next.setMonth(next.getMonth()+1);

const sisaHari=Math.ceil((next-todayDate)/(1000*60*60*24));
const batas=Math.floor(_saldoTotal/sisaHari);

runningText.classList.remove("blink");
runningText.style.color="#1e293b";

if(hideSaldo){
runningText.innerText=`üì¢ Sisa ${sisaHari} hari menuju gajian ‚Ä¢ Saldo Rp **** ‚Ä¢ Aman dipakai Rp **** / hari`;
return;
}

if(batas < 100000){
runningText.innerText=`‚ö†Ô∏è WARNING! Sisa ${sisaHari} hari menuju gajian ‚Ä¢ Jatah hanya ${rp(batas)} / hari ‚Ä¢ Kurangi pengeluaran!`;
runningText.style.color="#dc2626";
runningText.classList.add("blink");
}else{
runningText.innerText=`üì¢ Sisa ${sisaHari} hari menuju gajian ‚Ä¢ Saldo ${rp(_saldoTotal)} ‚Ä¢ Aman dipakai ${rp(batas)} / hari`;
}
}

/* LOAD DATA */
fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"TRANSACTIONS"})})
.then(r=>r.json())
.then(data=>{
for(let i=1;i<data.length;i++){
const row=data[i];
const jenis=row[2];
const nominal=Number(row[5])||0;
if(jenis==="income"){_incomeTotal+=nominal;_saldoTotal+=nominal}
if(jenis==="expense"){_expenseTotal+=nominal;_saldoTotal-=nominal}
if(i>data.length-6){
tbl.innerHTML+=`<tr><td>${row[1]}</td><td>${jenis}</td><td>${rp(nominal)}</td></tr>`;
}
}
renderSaldo();
updateRunningText();
});

/* BEKAL */
let totalBekal=0,totalKeluarBekal=0;
fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"BEKAL"})})
.then(r=>r.json())
.then(data=>{
for(let i=1;i<data.length;i++){totalBekal+=Number(data[i][2])||0;}
return fetch(url,{method:"POST",body:JSON.stringify({action:"getData",sheet:"PENGELUARAN_BEKAL"})});
})
.then(r=>r.json())
.then(data=>{
for(let i=1;i<data.length;i++){totalKeluarBekal+=Number(data[i][2])||0;}
_saldoBekal=totalBekal-totalKeluarBekal;
renderSaldo();

const persen=Math.max((_saldoBekal/totalBekal)*100,5);
barBekal.style.width=persen+"%";
if(_saldoBekal<=50000){saldoBekalEl.classList.add("blink");warningBekal.style.display="block";}
loader.style.display="none";
});
</script>

</body>
</html>
